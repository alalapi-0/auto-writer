<html lang="zh"> <!-- 指定中文语言环境 -->
<head> <!-- 头部开始 -->
  <meta charset="utf-8" /> <!-- 指定字符集 -->
  <title>Prompt 实验分析</title> <!-- 页面标题 -->
  <link rel="stylesheet" href="/static/style.css" /> <!-- 复用统一样式 -->
</head> <!-- 头部结束 -->
<body> <!-- 页面主体开始 -->
  <main> <!-- 主容器 -->
    <h1>Prompt 实验分析</h1> <!-- 页面主标题 -->
    <p>页面读取质量闸门数据，展示各 Prompt Variant 的命中率与评分。</p> <!-- 功能说明 -->
    <button id="export-btn">导出 CSV</button> <!-- 导出按钮 -->
    <table id="variant-table"> <!-- 数据表 -->
      <thead> <!-- 表头开始 -->
        <tr> <!-- 表头行 -->
          <th>Variant</th> <!-- Variant 列 -->
          <th>命中率</th> <!-- 命中率列 -->
          <th>平均质量分</th> <!-- 质量分列 -->
          <th>平均失败切换</th> <!-- 失败切换列 -->
          <th>样本数</th> <!-- 样本列 -->
        </tr>
      </thead> <!-- 表头结束 -->
      <tbody> <!-- 表体开始 -->
        <tr><td colspan="5">加载中...</td></tr> <!-- 初始占位 -->
      </tbody> <!-- 表体结束 -->
    </table> <!-- 数据表结束 -->
  </main> <!-- 主容器结束 -->
  <script> // 页面脚本
  const tableBody = document.querySelector('#variant-table tbody'); // 获取表体
  const exportBtn = document.getElementById('export-btn'); // 获取按钮

  function ensureLogin() { // 校验是否已登录
    const token = localStorage.getItem('jwt'); // 从 localStorage 获取 JWT
    if (!token) { // 未找到 token
      tableBody.innerHTML = '<tr><td colspan="5">请先登录 Dashboard。</td></tr>'; // 更新提示
      exportBtn.disabled = true; // 禁用导出
      return null; // 返回空
    }
    exportBtn.disabled = false; // 允许导出
    return token; // 返回 token
  }

  async function loadData() { // 拉取 Prompt 实验数据
    const token = ensureLogin(); // 校验登录
    if (!token) { // 未登录
      return; // 直接返回
    }
    const resp = await fetch('/api/prompt-experiments', { // 请求数据
      headers: { Authorization: `Bearer ${token}` }, // 设置鉴权头
    });
    if (!resp.ok) { // 请求失败
      tableBody.innerHTML = '<tr><td colspan="5">加载失败，请检查权限。</td></tr>'; // 显示错误
      return; // 结束
    }
    const data = await resp.json(); // 解析响应
    if (!data.items || !data.items.length) { // 无数据
      tableBody.innerHTML = '<tr><td colspan="5">暂无质量审计数据。</td></tr>'; // 显示提示
      return; // 结束
    }
    tableBody.innerHTML = data.items // 渲染每行
      .map(item => { // 遍历项目
        const rate = (item.hit_rate * 100).toFixed(2) + '%'; // 命中率百分比
        const quality = item.avg_quality.toFixed(2); // 格式化质量分
        const fallback = item.avg_fallback.toFixed(2); // 格式化失败切换
        return `<tr><td>${item.variant}</td><td>${rate}</td><td>${quality}</td><td>${fallback}</td><td>${item.count}</td></tr>`; // 构造行
      })
      .join(''); // 合并为字符串
  }

  exportBtn.addEventListener('click', async () => { // 绑定导出事件
    const token = ensureLogin(); // 校验登录
    if (!token) { // 未登录
      return; // 结束
    }
    const resp = await fetch('/api/prompt-experiments/export', { // 请求导出
      headers: { Authorization: `Bearer ${token}` }, // 设置鉴权
    });
    if (!resp.ok) { // 失败提示
      alert('导出失败，请检查权限。'); // 弹窗提示
      return; // 结束
    }
    const blob = await resp.blob(); // 获取二进制数据
    const url = URL.createObjectURL(blob); // 创建下载链接
    const link = document.createElement('a'); // 创建隐藏链接
    link.href = url; // 设置链接地址
    link.download = 'prompt_experiments.csv'; // 指定文件名
    document.body.appendChild(link); // 添加到 DOM
    link.click(); // 触发下载
    document.body.removeChild(link); // 移除节点
    URL.revokeObjectURL(url); // 释放 URL
  });

  loadData(); // 页面加载时自动执行
  </script> <!-- 脚本结束 -->
</body> <!-- 页面主体结束 -->
</html> <!-- 文档结束 -->
