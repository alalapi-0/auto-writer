<!DOCTYPE html> <!-- 总览页面文档类型 -->
<html lang="zh"> <!-- 指定中文环境 -->
<head> <!-- 头部开始 -->
  <meta charset="utf-8" /> <!-- 字符集 -->
  <title>AutoWriter Dashboard</title> <!-- 页面标题 -->
  <link rel="stylesheet" href="/static/style.css" /> <!-- 样式表 -->
</head> <!-- 头部结束 -->
<body> <!-- 页面主体开始 -->
  <main> <!-- 主容器 -->
    <h1>概览</h1> <!-- 标题 -->
    <p><a href="/alerts">查看告警面板</a></p> <!-- 告警入口 -->
    <p>使用浏览器存储的 JWT 自动调用 API，若未登录请先访问 <a href="/login">登录页</a>。</p> <!-- 登录提示 -->
    <section> <!-- 指标区域 -->
      <h2>近 7 天摘要</h2> <!-- 指标标题 -->
      <div id="summary">加载中...</div> <!-- 指标容器 -->
    </section>
    <section> <!-- 队列状态区域 -->
      <h2>Worker 队列状态</h2> <!-- 队列标题 -->
      <div id="queue-stats">加载中...</div> <!-- 队列统计容器 -->
      <div id="heartbeat-list">加载中...</div> <!-- 心跳列表容器 -->
    </section>
    <section> <!-- 死信箱区域 -->
      <h2>死信箱</h2> <!-- 死信标题 -->
      <div id="dead-letter-list">加载中...</div> <!-- 死信任务容器 -->
    </section>
  </main>
  <script> // 页面脚本
  async function loadSummary() { // 定义加载函数
    const token = localStorage.getItem('jwt'); // 读取 JWT
    if (!token) { // 未登录
      document.getElementById('summary').textContent = '请先登录'; // 提示
      document.getElementById('queue-stats').textContent = '请先登录'; // 提示队列
      document.getElementById('heartbeat-list').textContent = '请先登录'; // 提示心跳
      return;
    }
    const resp = await fetch('/api/metrics/summary?days=7', { // 调用 API
      headers: { Authorization: `Bearer ${token}` },
    });
    if (!resp.ok) { // 请求失败
      document.getElementById('summary').textContent = '加载失败，请检查权限';
      return;
    }
    const data = await resp.json(); // 解析数据
    document.getElementById('summary').textContent = `成功 ${data.success} 次，错误 ${data.errors} 次`; // 展示数据
    const dispatchResp = await fetch('/api/dispatch/summary', { // 拉取队列摘要
      headers: { Authorization: `Bearer ${token}` },
    });
    if (!dispatchResp.ok) { // 校验响应
      document.getElementById('queue-stats').textContent = '队列状态加载失败'; // 显示错误
      document.getElementById('heartbeat-list').textContent = '心跳加载失败'; // 显示错误
      return; // 结束
    }
    const dispatchData = await dispatchResp.json(); // 解析队列数据
    const stats = dispatchData.queue || {}; // 队列统计
    const heartbeat = dispatchData.heartbeats || []; // 心跳列表
    const deadLetters = dispatchData.dead_letters || []; // 死信任务
    document.getElementById('queue-stats').textContent = `待处理 ${stats.pending || 0}，租约中 ${stats.leased || 0}，已完成 ${stats.done || 0}，死亡 ${stats.dead || 0}`; // 展示统计
    if (!heartbeat.length) { // 无心跳
      document.getElementById('heartbeat-list').textContent = '暂无 Worker 心跳'; // 显示提示
    } else { // 有心跳
      document.getElementById('heartbeat-list').innerHTML = heartbeat // 渲染心跳列表
        .map(item => { // 逐项渲染
          const meta = item.meta && item.meta.concurrency ? ` 并发 ${item.meta.concurrency}` : ''; // 并发信息
          const cls = item.is_stale ? 'heartbeat-item offline' : 'heartbeat-item'; // 根据心跳状态确定样式
          return `<div class="${cls}">${item.agent_name} @ ${item.last_seen_at}${meta}</div>`; // 返回 HTML 片段
        })
        .join(''); // 合并字符串
    }
    const deadContainer = document.getElementById('dead-letter-list'); // 死信容器
    if (!deadLetters.length) { // 无死信
      deadContainer.textContent = '暂无死信任务'; // 显示提示
    } else { // 存在死信
      deadContainer.innerHTML = deadLetters
        .map(item => { // 构造每条死信
          const quarantine = item.quarantine_dir ? ` → ${item.quarantine_dir}` : ''; // 隔离目录
          const error = item.error ? `（${item.error}）` : ''; // 错误信息
          return `<div class="dead-letter-item">#${item.task_id} Profile ${item.profile_id} 重试 ${item.attempts} 次${quarantine}${error}</div>`; // 返回条目
        })
        .join(''); // 合并
    }
  }
  loadSummary(); // 调用加载函数
  </script>
</body> <!-- 页面主体结束 -->
</html>
